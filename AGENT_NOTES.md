# Agent Notes

Purpose: persistent notes for agent behavior and repo-specific learnings.

## How To Update
- Add entries with date/time.
- Keep notes short and actionable.
- Prefer concrete examples (file paths, commands, behaviors).

## Mistakes Log
- Format: `[YYYY-MM-DD HH:MM] mistake -> fix -> prevention`

## Non-Obvious Code Findings
- Format: `[YYYY-MM-DD HH:MM] finding (why it matters) [paths/commands]`

## User Preferences (Likes / Dislikes)
- Format: `[YYYY-MM-DD HH:MM] like/dislike -> implication for future work`

## Non-Obvious Code Findings
- [2026-02-07 20:19] Multi-select delete in `apps/web/src/routes/sources/index.tsx` was implemented as N single `DELETE /api/sources/{id}` calls via `Promise.all`, which allowed partial archive on failures. Introduced atomic batch archive endpoint planning/implementation to enforce all-or-nothing behavior.
- [2026-02-07 22:46] Prefer named constants over magic numbers in domain/application logic (for example, batch limits in `SourceService`) to keep constraints explicit and easier to change safely.

## User Preferences (Likes / Dislikes)
- [2026-02-07 20:19] User confirmed that "delete" semantics for Sources must mean archive (DEC-012 behavior), including batch flows -> keep UI copy and API naming explicit about archive semantics behind delete actions.

## Mistakes Log
- [2026-02-07 20:20] Wrote a brittle archive list assertion that depended on result ordering in `SourceControllerTest` -> changed to ID-presence assertion (`$[?(@.id=='...')]`) -> avoid index-based JSON assertions when endpoint order is not guaranteed.
- [2026-02-09 08:35] Tried verifying event publication through `@MockitoBean ApplicationEventPublisher` in controller integration tests -> mock wasn’t reliably intercepting Spring's publisher wiring -> moved publication verification to focused service unit tests (`SourceServiceEventTest`) and kept controller tests on HTTP/state behavior -> for event assertions prefer unit/service tests over full-context controller tests.

## Non-Obvious Code Findings
- [2026-02-09 08:35] Source restore aligns with domain model/events as `ARCHIVED -> ACTIVE` only; no re-extraction and no status memory. Implemented via `Source.restore()` + `SourceStatus.canTransitionTo` update and idempotent service behavior in `restoreSource` (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Source.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/SourceStatus.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`).
- [2026-02-09 08:35] Domain events were added as plain data events (`SourceArchivedEvent`, `SourceRestoredEvent`) and logged via `@EventListener` in `EventsConfig`; this gives event visibility now without introducing downstream coupling yet (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/event`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/events/EventsConfig.kt`).
- [2026-02-11 10:19] Spring AI was switched from OpenAI starter to Zhipu starter; app/test stability requires explicitly disabling non-chat models (`spring.ai.model.embedding=none`, `spring.ai.model.image=none`) unless intentionally used, otherwise context boot fails without Zhipu API key (`apps/api/build.gradle.kts`, `apps/api/src/main/resources/application.yml`, `apps/api/src/test/resources/application-test.yml`).
- [2026-02-11 11:49] Slice 2 Topics implemented using domain-native persistence (`topics` + `topic_links`) instead of `enrichments`; pending suggestions are represented as `TopicLink(status=SUGGESTED)` and confirmation promotes both link/topic states. Dismissal archives orphan suggested topics (`apps/api/src/main/resources/db/migration/V20260211104500__topics_slice2.sql`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 11:49] Frontend lint gate failed due pre-existing `react-refresh/only-export-components` violations in shared UI primitives exporting variant helpers; added file-level disable comments to keep project lint passing during Slice 2 delivery (`apps/web/src/components/ui/button.tsx`, `apps/web/src/components/ui/badge.tsx`).
- [2026-02-11 12:27] Topic suggestion trigger corrected from extraction-only to activation-based eventing: `SourceActivatedEvent` now fires for both fresh extraction and shared snapshot cache reuse, so per-user topic suggestion runs on cache hits too (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicSuggestionEventHandler.kt`).
- [2026-02-11 12:40] Zhipu 401s can come from platform/base-url mismatch despite a valid key: Z.ai keys require `https://api.z.ai/api/paas` while BigModel keys use `https://open.bigmodel.cn/api/paas`; aligned defaults and explicit chat overrides to avoid ambiguous runtime wiring (`apps/api/src/main/resources/application.yml`, `.env.example`, `docker-compose.yml`).
- [2026-02-11 13:58] Source topic handling now supports an atomic single-action flow: `POST /api/sources/{id}/topics/apply` confirms selected suggestions and dismisses the rest in one transaction; `GET /api/sources/{id}/topics/active` exposes confirmed source-level topics for the note UI (`apps/api/src/main/kotlin/com/briefy/api/api/SourceController.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 13:58] Topic suggestion prompt now includes existing user ACTIVE topics (`id` + `name`) and supports match-by-`existingTopicId` output before creating new topics, aligning with DEC-014 user-authority topic design (`apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicSuggestionService.kt`).

## User Preferences (Likes / Dislikes)
- [2026-02-11 13:58] User dislikes the plain checkbox suggestion UI and prefers a single “keep selected, discard rest” action -> prioritize streamlined batch-selection interactions in source topic review flows (`apps/web/src/routes/sources/$sourceId.tsx`).
- [2026-02-11 14:18] User does not want archived topics surfaced in the Topics UI; suggested topics should be meaningful by exposing the related sources directly -> keep Topics page focused on active/suggested and ensure suggested topic detail resolves to suggested source links (`apps/web/src/routes/topics/index.tsx`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 15:46] `POST /api/topics` initially returned 500 when `sourceIds` was omitted because request binding treated `sourceIds` as null for a non-null constructor param; changed `CreateTopicRequest.sourceIds` to nullable and normalized via `orEmpty()` in controller (`apps/api/src/main/kotlin/com/briefy/api/api/TopicController.kt`).
- [2026-02-11 16:02] Source detail topic UX now gates suggestion review by active-topic presence: when source has active topics, suggestion panel is hidden and manual add goes through `POST /api/topics` with current `sourceId` so created topics and links are immediately ACTIVE (`apps/web/src/routes/sources/$sourceId.tsx`, `apps/web/src/routes/topics/index.tsx`).
- [2026-02-11 19:00] Topic lifecycle update: orphan `SUGGESTED` topics are now hard-deleted (instead of archived) when their last live source link is dismissed; topics with any remaining live links are preserved (`apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 23:56] Extraction provider routing now resolves per-user at runtime via `ExtractionProviderResolver` and decrypts Firecrawl API keys lazily through `UserSettingsService`; Jsoup remains the fallback when Firecrawl is disabled/unconfigured (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/ExtractionProviderResolver.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/settings/UserSettingsService.kt`).
- [2026-02-11 23:56] Added `metadata_ai_formatted` through extraction pipeline and API DTOs so downstream clients can distinguish markdown-ready provider output (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Metadata.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceDto.kt`).
- [2026-02-11 23:56] User requested to defer X API extraction implementation to a follow-up PR; this slice keeps X-related columns in settings for forward compatibility but only enables Firecrawl + Jsoup runtime providers.
- [2026-02-11 23:56] Generated two Flyway files in the same second with `scripts/genDDLFile.sh`, causing duplicate version numbers and a typo in one filename -> renamed to unique timestamps and corrected name -> when creating multiple migrations quickly, verify timestamp uniqueness before editing contents.
- [2026-02-12 00:19] Extraction routing now emits explicit resolver logs with fallback reasons (`platform_excluded`, `firecrawl_disabled_or_unconfigured`, `missing_firecrawl_key`, `firecrawl_enabled`) and persists `metadata_extraction_provider` on both `sources` and `shared_source_snapshots` for per-source auditability (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/ExtractionProviderResolver.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Metadata.kt`, `apps/api/src/main/resources/db/migration/V20260212001657__add_extraction_provider_to_source_metadata.sql`).
- [2026-02-12 00:19] Adding runtime usage of `ExtractionProvider.id` broke tests using Mockito mocks because interface properties default to null in unstubbed mocks -> explicitly stub `extractionProvider.id` in affected tests before extraction calls.
- [2026-02-12 01:05] Added async AI formatting pipeline for extracted source content via dedicated `SourceContentFormattingRequestedEvent` (AFTER_COMMIT + @Async). Formatting is extractor-aware (`extractorId` in event) and currently implemented for `JSOUP` through reusable formatter strategy interface (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormattingEventHandler.kt`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/formatting/ExtractionContentFormatter.kt`).
- [2026-02-12 01:05] Shared snapshots are immutable value objects (`content`/`metadata` are `val`), so formatter updates create a new latest snapshot version instead of in-place mutation. Keeps cache freshness timestamps unchanged while propagating formatted content to future cache reuses (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormatterService.kt`).
- [2026-02-12 10:15] Added per-user AI use-case settings (`topic_extraction`, `source_formatting`) with provider+model selection in new `user_ai_settings` table and `/api/settings/ai` endpoints; defaults preserve existing behavior (`zhipuai + glm-4.7-flash` for topics, `zhipuai + glm-4.7` for formatting) to avoid rollout regressions (`apps/api/src/main/kotlin/com/briefy/api/application/settings/UserAiSettingsService.kt`, `apps/api/src/main/resources/db/migration/V20260212100515__user_ai_settings.sql`).
- [2026-02-12 10:15] Multi-provider AI runtime currently routes `zhipuai` via Spring AI `ChatModel` and `google_genai` via direct Google Generative Language API call in `AiAdapter`; provider availability is enforced server-side by key presence before any use-case update/save (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/ai/AiAdapter.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/settings/UserAiSettingsService.kt`).
- [2026-02-12 13:57] Homepage implementation: `/` is now a public, Obsidian-aligned landing page focused on the knowledge retention loop (Source -> Briefing -> Takeaway -> Recall); shared header navigation now branches by auth state (guest: Log in/Sign up, member: Topics/Library/Log out), and brand links to `/` to keep homepage discoverable (`apps/web/src/routes/index.tsx`, `apps/web/src/routes/__root.tsx`).
- [2026-02-12 14:33] Homepage expansion updated with two linked vertical sections: Content Consumption (`/content-consumption`) and Content Generation (`/content-generation`), each with dedicated route page and auth-aware CTA paths. Context/messaging follows Briefy Obsidian notes for ConsumptionSession/CompletionMethod/RLCR and proposal-generation MVP scope.
- [2026-02-12 14:38] User prefers commercial landing copy over internal/product-development language. Homepage and use-case pages should prioritize audience outcomes, value propositions, and conversion CTAs; avoid MVP/internal metrics wording in public-facing sections.
- [2026-02-14 14:22] Added YouTube-specific ingestion pipeline: `SourceType.VIDEO`, durable `source_extraction_jobs` queue, `YouTubeExtractionWorker` scheduler, and `YouTubeExtractionProvider` with captions-first + Whisper fallback; non-YouTube extraction remains synchronous (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/YouTubeExtractionWorker.kt`, `apps/api/src/main/resources/db/migration/V20260214120000__youtube_extraction_jobs_and_metadata.sql`).
- [2026-02-14 14:22] Source detail UI now renders embedded YouTube player + transcript metadata and supports pending transcription states for submitted/extracting video sources (`apps/web/src/routes/sources/$sourceId.tsx`, `apps/web/src/lib/api/types.ts`).
- [2026-02-14 14:22] Wrote Kotlin service methods with default parameters and then verified mocked calls in tests; Mockito matcher verification failed due generated `$default` bridging -> removed default args from mocked service methods and passed `Instant.now()` explicitly at call sites (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceExtractionJobService.kt`, `apps/api/src/test/kotlin/com/briefy/api/application/source/SourceServiceEventTest.kt`).
- [2026-02-14 14:36] PR #20 review fixes: queued retries now reset `FAILED` sources before extraction, worker reclaims stale `PROCESSING` jobs to `RETRY`, and URL platform detection switched from substring matching to exact/suffix host matching to avoid false YouTube routing (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceExtractionJobService.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Url.kt`).
- [2026-02-14 14:39] `YouTubeExtractionProvider.runCommand` originally waited for process completion before draining stdout, which can hang `yt-dlp` on large JSON output and trigger false timeouts. Updated to stream output concurrently, log command start/finish duration, and include timeout/failure output previews for diagnosis (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/YouTubeExtractionProvider.kt`).
- [2026-02-14 14:51] Metadata extraction for YouTube was failing because `runCommand` output cap (500k chars) truncated `yt-dlp --dump-single-json` payloads, causing JSON EOF parse errors. Switched metadata fetch to `yt-dlp --print` for only required fields (`id,title,uploader,duration,upload_date`) to avoid huge JSON and eliminate truncation-dependent parsing (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/YouTubeExtractionProvider.kt`).
- [2026-02-14 15:05] YouTube subtitle transcripts now trigger async source formatting via new `YouTubeAiContentFormatter` (`ExtractionProviderId.YOUTUBE`) with forced `google_genai` + `gemini-2.5-flash-lite`; whisper transcripts stay `aiFormatted=true` and skip formatter. Formatter metadata rewrite now preserves YouTube-specific fields (`videoId`, embed URL, transcript source/language) to avoid losing video context after formatting (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/formatting/YouTubeAiContentFormatter.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormatterService.kt`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/YouTubeExtractionProvider.kt`).
- [2026-02-14 15:14] Obsidian documentation structure now includes flow-centric folders under `marcjaner/Briefy/flows` with extraction fully documented (orchestration + per-extractor + formatter mermaid diagrams) and placeholder indexes for enrichment/briefing/retention/export; `00-Index.md` now links `flows/00-Flows-Index` for discovery.
- [2026-02-14 15:25] Addressed remaining PR #20 review risks: added YouTube job lock heartbeats (`refreshProcessingLock`) to prevent stale reclaim races during long transcriptions, and tightened `SourceTypeClassifier` to mark `VIDEO` only for supported YouTube video URL shapes (`watch` with `v` and no `list`, `shorts`, `youtu.be/<id>`), avoiding queue churn on channel/playlist pages.
- [2026-02-14 17:30] Telegram integration added with persistent one-time account linking (`/api/settings/integrations/telegram`) + async ingestion queue (`telegram_ingestion_jobs`) to keep webhook responses fast while reusing `SourceService` ingestion semantics for dedupe/extraction (`apps/api/src/main/kotlin/com/briefy/api/application/telegram/*`, `apps/api/src/main/resources/db/migration/V20260214183000__telegram_bot_integration.sql`).
- [2026-02-14 17:30] `telegrambots-springboot-webhook-starter:9.3.0` compiles on current Spring Boot 4 project, but upstream starter POM still imports Spring Boot 3.5.5 BOM; keep an eye on transitive drift and run compile/test checks after version bumps (`apps/api/build.gradle.kts`).
