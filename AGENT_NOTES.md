# Agent Notes

Purpose: persistent notes for agent behavior and repo-specific learnings.

## How To Update
- Add entries with date/time.
- Keep notes short and actionable.
- Prefer concrete examples (file paths, commands, behaviors).

## Mistakes Log
- Format: `[YYYY-MM-DD HH:MM] mistake -> fix -> prevention`

## Non-Obvious Code Findings
- Format: `[YYYY-MM-DD HH:MM] finding (why it matters) [paths/commands]`

## User Preferences (Likes / Dislikes)
- Format: `[YYYY-MM-DD HH:MM] like/dislike -> implication for future work`

## Non-Obvious Code Findings
- [2026-02-07 20:19] Multi-select delete in `apps/web/src/routes/sources/index.tsx` was implemented as N single `DELETE /api/sources/{id}` calls via `Promise.all`, which allowed partial archive on failures. Introduced atomic batch archive endpoint planning/implementation to enforce all-or-nothing behavior.
- [2026-02-07 22:46] Prefer named constants over magic numbers in domain/application logic (for example, batch limits in `SourceService`) to keep constraints explicit and easier to change safely.

## User Preferences (Likes / Dislikes)
- [2026-02-07 20:19] User confirmed that "delete" semantics for Sources must mean archive (DEC-012 behavior), including batch flows -> keep UI copy and API naming explicit about archive semantics behind delete actions.

## Mistakes Log
- [2026-02-07 20:20] Wrote a brittle archive list assertion that depended on result ordering in `SourceControllerTest` -> changed to ID-presence assertion (`$[?(@.id=='...')]`) -> avoid index-based JSON assertions when endpoint order is not guaranteed.
- [2026-02-09 08:35] Tried verifying event publication through `@MockitoBean ApplicationEventPublisher` in controller integration tests -> mock wasn’t reliably intercepting Spring's publisher wiring -> moved publication verification to focused service unit tests (`SourceServiceEventTest`) and kept controller tests on HTTP/state behavior -> for event assertions prefer unit/service tests over full-context controller tests.

## Non-Obvious Code Findings
- [2026-02-09 08:35] Source restore aligns with domain model/events as `ARCHIVED -> ACTIVE` only; no re-extraction and no status memory. Implemented via `Source.restore()` + `SourceStatus.canTransitionTo` update and idempotent service behavior in `restoreSource` (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Source.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/SourceStatus.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`).
- [2026-02-09 08:35] Domain events were added as plain data events (`SourceArchivedEvent`, `SourceRestoredEvent`) and logged via `@EventListener` in `EventsConfig`; this gives event visibility now without introducing downstream coupling yet (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/event`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/events/EventsConfig.kt`).
- [2026-02-11 10:19] Spring AI was switched from OpenAI starter to Zhipu starter; app/test stability requires explicitly disabling non-chat models (`spring.ai.model.embedding=none`, `spring.ai.model.image=none`) unless intentionally used, otherwise context boot fails without Zhipu API key (`apps/api/build.gradle.kts`, `apps/api/src/main/resources/application.yml`, `apps/api/src/test/resources/application-test.yml`).
- [2026-02-11 11:49] Slice 2 Topics implemented using domain-native persistence (`topics` + `topic_links`) instead of `enrichments`; pending suggestions are represented as `TopicLink(status=SUGGESTED)` and confirmation promotes both link/topic states. Dismissal archives orphan suggested topics (`apps/api/src/main/resources/db/migration/V20260211104500__topics_slice2.sql`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 11:49] Frontend lint gate failed due pre-existing `react-refresh/only-export-components` violations in shared UI primitives exporting variant helpers; added file-level disable comments to keep project lint passing during Slice 2 delivery (`apps/web/src/components/ui/button.tsx`, `apps/web/src/components/ui/badge.tsx`).
- [2026-02-11 12:27] Topic suggestion trigger corrected from extraction-only to activation-based eventing: `SourceActivatedEvent` now fires for both fresh extraction and shared snapshot cache reuse, so per-user topic suggestion runs on cache hits too (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicSuggestionEventHandler.kt`).
- [2026-02-11 12:40] Zhipu 401s can come from platform/base-url mismatch despite a valid key: Z.ai keys require `https://api.z.ai/api/paas` while BigModel keys use `https://open.bigmodel.cn/api/paas`; aligned defaults and explicit chat overrides to avoid ambiguous runtime wiring (`apps/api/src/main/resources/application.yml`, `.env.example`, `docker-compose.yml`).
- [2026-02-11 13:58] Source topic handling now supports an atomic single-action flow: `POST /api/sources/{id}/topics/apply` confirms selected suggestions and dismisses the rest in one transaction; `GET /api/sources/{id}/topics/active` exposes confirmed source-level topics for the note UI (`apps/api/src/main/kotlin/com/briefy/api/api/SourceController.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 13:58] Topic suggestion prompt now includes existing user ACTIVE topics (`id` + `name`) and supports match-by-`existingTopicId` output before creating new topics, aligning with DEC-014 user-authority topic design (`apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicSuggestionService.kt`).

## User Preferences (Likes / Dislikes)
- [2026-02-11 13:58] User dislikes the plain checkbox suggestion UI and prefers a single “keep selected, discard rest” action -> prioritize streamlined batch-selection interactions in source topic review flows (`apps/web/src/routes/sources/$sourceId.tsx`).
- [2026-02-11 14:18] User does not want archived topics surfaced in the Topics UI; suggested topics should be meaningful by exposing the related sources directly -> keep Topics page focused on active/suggested and ensure suggested topic detail resolves to suggested source links (`apps/web/src/routes/topics/index.tsx`, `apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 15:46] `POST /api/topics` initially returned 500 when `sourceIds` was omitted because request binding treated `sourceIds` as null for a non-null constructor param; changed `CreateTopicRequest.sourceIds` to nullable and normalized via `orEmpty()` in controller (`apps/api/src/main/kotlin/com/briefy/api/api/TopicController.kt`).
- [2026-02-11 16:02] Source detail topic UX now gates suggestion review by active-topic presence: when source has active topics, suggestion panel is hidden and manual add goes through `POST /api/topics` with current `sourceId` so created topics and links are immediately ACTIVE (`apps/web/src/routes/sources/$sourceId.tsx`, `apps/web/src/routes/topics/index.tsx`).
- [2026-02-11 19:00] Topic lifecycle update: orphan `SUGGESTED` topics are now hard-deleted (instead of archived) when their last live source link is dismissed; topics with any remaining live links are preserved (`apps/api/src/main/kotlin/com/briefy/api/application/topic/TopicService.kt`).
- [2026-02-11 23:56] Extraction provider routing now resolves per-user at runtime via `ExtractionProviderResolver` and decrypts Firecrawl API keys lazily through `UserSettingsService`; Jsoup remains the fallback when Firecrawl is disabled/unconfigured (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/ExtractionProviderResolver.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/settings/UserSettingsService.kt`).
- [2026-02-11 23:56] Added `metadata_ai_formatted` through extraction pipeline and API DTOs so downstream clients can distinguish markdown-ready provider output (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Metadata.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceDto.kt`).
- [2026-02-11 23:56] User requested to defer X API extraction implementation to a follow-up PR; this slice keeps X-related columns in settings for forward compatibility but only enables Firecrawl + Jsoup runtime providers.
- [2026-02-11 23:56] Generated two Flyway files in the same second with `scripts/genDDLFile.sh`, causing duplicate version numbers and a typo in one filename -> renamed to unique timestamps and corrected name -> when creating multiple migrations quickly, verify timestamp uniqueness before editing contents.
- [2026-02-12 00:19] Extraction routing now emits explicit resolver logs with fallback reasons (`platform_excluded`, `firecrawl_disabled_or_unconfigured`, `missing_firecrawl_key`, `firecrawl_enabled`) and persists `metadata_extraction_provider` on both `sources` and `shared_source_snapshots` for per-source auditability (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/ExtractionProviderResolver.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Metadata.kt`, `apps/api/src/main/resources/db/migration/V20260212001657__add_extraction_provider_to_source_metadata.sql`).
- [2026-02-12 00:19] Adding runtime usage of `ExtractionProvider.id` broke tests using Mockito mocks because interface properties default to null in unstubbed mocks -> explicitly stub `extractionProvider.id` in affected tests before extraction calls.
- [2026-02-12 01:05] Added async AI formatting pipeline for extracted source content via dedicated `SourceContentFormattingRequestedEvent` (AFTER_COMMIT + @Async). Formatting is extractor-aware (`extractorId` in event) and currently implemented for `JSOUP` through reusable formatter strategy interface (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormattingEventHandler.kt`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/formatting/ExtractionContentFormatter.kt`).
- [2026-02-12 01:05] Shared snapshots are immutable value objects (`content`/`metadata` are `val`), so formatter updates create a new latest snapshot version instead of in-place mutation. Keeps cache freshness timestamps unchanged while propagating formatted content to future cache reuses (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormatterService.kt`).
- [2026-02-12 10:15] Added per-user AI use-case settings (`topic_extraction`, `source_formatting`) with provider+model selection in new `user_ai_settings` table and `/api/settings/ai` endpoints; defaults preserve existing behavior (`zhipuai + glm-4.7-flash` for topics, `zhipuai + glm-4.7` for formatting) to avoid rollout regressions (`apps/api/src/main/kotlin/com/briefy/api/application/settings/UserAiSettingsService.kt`, `apps/api/src/main/resources/db/migration/V20260212100515__user_ai_settings.sql`).
- [2026-02-12 10:15] Multi-provider AI runtime currently routes `zhipuai` via Spring AI `ChatModel` and `google_genai` via direct Google Generative Language API call in `AiAdapter`; provider availability is enforced server-side by key presence before any use-case update/save (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/ai/AiAdapter.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/settings/UserAiSettingsService.kt`).
- [2026-02-12 13:57] Homepage implementation: `/` is now a public, Obsidian-aligned landing page focused on the knowledge retention loop (Source -> Briefing -> Takeaway -> Recall); shared header navigation now branches by auth state (guest: Log in/Sign up, member: Topics/Library/Log out), and brand links to `/` to keep homepage discoverable (`apps/web/src/routes/index.tsx`, `apps/web/src/routes/__root.tsx`).
- [2026-02-12 14:33] Homepage expansion updated with two linked vertical sections: Content Consumption (`/content-consumption`) and Content Generation (`/content-generation`), each with dedicated route page and auth-aware CTA paths. Context/messaging follows Briefy Obsidian notes for ConsumptionSession/CompletionMethod/RLCR and proposal-generation MVP scope.
- [2026-02-12 14:38] User prefers commercial landing copy over internal/product-development language. Homepage and use-case pages should prioritize audience outcomes, value propositions, and conversion CTAs; avoid MVP/internal metrics wording in public-facing sections.
- [2026-02-12 22:37] Obsidian documentation drift check: `05-Domain-Model.md` was partially updated for DEC-040 (`UserExtractionSettings`, metadata provenance) but still misses implemented `UserAiSettings`, still describes `TopicLink` lifecycle as `active -> removed` despite `SUGGESTED` status in code, and still lists `Source.audioContent` even though `Source` currently has no audio field; `00-Index.md` still says “authentication in progress” and “Knowledge Graph not yet modeled” despite implemented auth/topics/source domain slices.
- [2026-02-12 22:41] Updated Obsidian docs per user request: `05-Domain-Model.md` now includes `UserAiSettings` and corrected `TopicLink` lifecycle to `suggested -> active -> removed`; `00-Index.md` status and subdomain implementation table now reflect implemented auth and KG/topic slices. Left source audio-content note untouched by explicit request.
- [2026-02-12 22:46] Implementation plan now labels Slice 2 (Topics/TopicLink) as implemented and keeps remaining slices (Briefings, Takeaways, etc.) flagged as pending to keep roadmap consistent with the current system state, addressing the stale “Current Reality” list.
- [2026-02-12 23:22] Added `X_API` extraction provider with lookup-first flow for X/Twitter links: default thread-path behavior, article detection (`tweet.fields=article`) with refetch for article expansions, and author-only conversation assembly fallback to root post when thread lookup fails (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/XApiExtractionProvider.kt`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/ExtractionProviderResolver.kt`).
- [2026-02-12 23:22] Extraction settings now expose `x_api` as a first-class provider (enable/configure/delete key) using existing encrypted user settings columns; resolver prioritizes `x_api` on X platforms and otherwise keeps current Firecrawl/Jsoup behavior (`apps/api/src/main/kotlin/com/briefy/api/application/settings/UserSettingsService.kt`, `apps/api/src/test/kotlin/com/briefy/api/api/SettingsControllerTest.kt`).
- [2026-02-12 23:22] Implementation pitfall: using `com.fasterxml.jackson.databind.JsonNode` in X API DTOs failed at runtime with `tools.jackson` mapper in this stack; switched nested payload fields (`note_tweet`, `article`, `entities`) to `Map<String, Any?>` access helpers to avoid cross-package Jackson type mismatch.
- [2026-02-14 14:22] Added YouTube-specific ingestion pipeline: `SourceType.VIDEO`, durable `source_extraction_jobs` queue, `YouTubeExtractionWorker` scheduler, and `YouTubeExtractionProvider` with captions-first + Whisper fallback; non-YouTube extraction remains synchronous (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/YouTubeExtractionWorker.kt`, `apps/api/src/main/resources/db/migration/V20260214120000__youtube_extraction_jobs_and_metadata.sql`).
- [2026-02-14 14:22] Source detail UI now renders embedded YouTube player + transcript metadata and supports pending transcription states for submitted/extracting video sources (`apps/web/src/routes/sources/$sourceId.tsx`, `apps/web/src/lib/api/types.ts`).
- [2026-02-14 14:22] Wrote Kotlin service methods with default parameters and then verified mocked calls in tests; Mockito matcher verification failed due generated `$default` bridging -> removed default args from mocked service methods and passed `Instant.now()` explicitly at call sites (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceExtractionJobService.kt`, `apps/api/src/test/kotlin/com/briefy/api/application/source/SourceServiceEventTest.kt`).
- [2026-02-14 14:36] PR #20 review fixes: queued retries now reset `FAILED` sources before extraction, worker reclaims stale `PROCESSING` jobs to `RETRY`, and URL platform detection switched from substring matching to exact/suffix host matching to avoid false YouTube routing (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceExtractionJobService.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Url.kt`).
- [2026-02-14 14:39] `YouTubeExtractionProvider.runCommand` originally waited for process completion before draining stdout, which can hang `yt-dlp` on large JSON output and trigger false timeouts. Updated to stream output concurrently, log command start/finish duration, and include timeout/failure output previews for diagnosis (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/YouTubeExtractionProvider.kt`).
- [2026-02-14 14:51] Metadata extraction for YouTube was failing because `runCommand` output cap (500k chars) truncated `yt-dlp --dump-single-json` payloads, causing JSON EOF parse errors. Switched metadata fetch to `yt-dlp --print` for only required fields (`id,title,uploader,duration,upload_date`) to avoid huge JSON and eliminate truncation-dependent parsing (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/YouTubeExtractionProvider.kt`).
- [2026-02-14 15:05] YouTube subtitle transcripts now trigger async source formatting via new `YouTubeAiContentFormatter` (`ExtractionProviderId.YOUTUBE`) with forced `google_genai` + `gemini-2.5-flash-lite`; whisper transcripts stay `aiFormatted=true` and skip formatter. Formatter metadata rewrite now preserves YouTube-specific fields (`videoId`, embed URL, transcript source/language) to avoid losing video context after formatting (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/formatting/YouTubeAiContentFormatter.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormatterService.kt`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/extraction/YouTubeExtractionProvider.kt`).
- [2026-02-14 15:14] Obsidian documentation structure now includes flow-centric folders under `marcjaner/Briefy/flows` with extraction fully documented (orchestration + per-extractor + formatter mermaid diagrams) and placeholder indexes for enrichment/briefing/retention/export; `00-Index.md` now links `flows/00-Flows-Index` for discovery.
- [2026-02-14 15:25] Addressed remaining PR #20 review risks: added YouTube job lock heartbeats (`refreshProcessingLock`) to prevent stale reclaim races during long transcriptions, and tightened `SourceTypeClassifier` to mark `VIDEO` only for supported YouTube video URL shapes (`watch` with `v` and no `list`, `shorts`, `youtu.be/<id>`), avoiding queue churn on channel/playlist pages.
- [2026-02-14 17:30] Telegram integration added with persistent one-time account linking (`/api/settings/integrations/telegram`) + async ingestion queue (`telegram_ingestion_jobs`) to keep webhook responses fast while reusing `SourceService` ingestion semantics for dedupe/extraction (`apps/api/src/main/kotlin/com/briefy/api/application/telegram/*`, `apps/api/src/main/resources/db/migration/V20260214183000__telegram_bot_integration.sql`).
- [2026-02-14 17:30] `telegrambots-springboot-webhook-starter:9.3.0` compiles on current Spring Boot 4 project, but upstream starter POM still imports Spring Boot 3.5.5 BOM; keep an eye on transitive drift and run compile/test checks after version bumps (`apps/api/build.gradle.kts`).
- [2026-02-15 12:55] Settings UI polish: AI model/provider dropdowns now use shared shadcn-style `Select` primitives (`apps/web/src/components/ui/select.tsx`) instead of native `<select>`, Telegram link code block now includes right-aligned copy action with transient check-icon feedback, and source detail manual suggestion input now submits on Enter (`apps/web/src/routes/settings/index.tsx`, `apps/web/src/routes/sources/$sourceId.tsx`).
- [2026-02-15 12:55] Frontend component stack detail: this repo standardizes on the unified `radix-ui` package for primitives (not per-package `@radix-ui/*` imports), so new UI wrappers should follow that pattern for consistency (`apps/web/src/components/ui/*`).

## User Preferences (Likes / Dislikes)
- [2026-02-15 12:55] For Telegram link code copy UX, user preference is lightweight inline feedback (copy icon toggles to check briefly) rather than toast-based notifications.
- [2026-02-15 12:55] Enter-to-submit behavior should be added for the manual topic suggestion field in source detail; scope intentionally excludes other manual input fields unless requested.
- [2026-02-17 00:00] Source detail now gates unformatted content (`metadata.aiFormatted=false`) behind an inline formatting-wait panel with `See raw content`, plus 2s polling via `getSource` until formatting completes. Raw override auto-resets on source change and auto-switches back to formatted view when ready (`apps/web/src/routes/sources/$sourceId.tsx`).
- [2026-02-17 00:00] Source detail topic suggestions now have dedicated bounded auto-refresh: while source is ACTIVE with no active topics and no suggestions, frontend polls `GET /api/sources/{id}/topics/suggestions` every 2s for up to 60s, then stops; this restores automatic suggestion appearance without re-triggering section animations on unrelated source refetches (`apps/web/src/routes/sources/$sourceId.tsx`).
## 2026-02-18
- Locked DEC-052 to DEC-055 in Obsidian Briefy notes (ActionRouter failures, follow-up context resolution, conflict surfacing strategy, conversation title strategy).
- User preference: choose simple, deterministic V1 behavior over heavier infra/modeling when both are viable.
- 2026-02-18: Locked DEC-056 (V1 embeddings simplified to one fixed global provider/model and fixed dimension; no user embedding settings in V1).
- 2026-02-18: Locked DEC-057 (V1 chat scope limited to briefing flow; out-of-scope intents return guidance + CTA).
- 2026-02-18: Added Obsidian section  with  and ; linked from .
- 2026-02-18: Added Obsidian section `marcjaner/Briefy/ai` with `00-AI-Index.md` and `10-Observability-Plan.md`; linked from `00-Index.md`.
- [2026-02-18 22:20] Phase 1 AI observability foundation added in backend: adapter-level OTel span wrapper now records useCase/provider/model/latency/outcome with normalized error categories and prompt/output sanitized previews by default; Langfuse OTLP bootstrap is env-driven and safe-noop when disabled or credentials missing (`apps/api/src/main/kotlin/com/briefy/api/infrastructure/ai/AiAdapter.kt`, `apps/api/src/main/kotlin/com/briefy/api/infrastructure/ai/AiCallObserver.kt`, `apps/api/src/main/kotlin/com/briefy/api/config/AiObservabilityBootstrap.kt`, `apps/api/src/main/resources/application.yml`).
- [2026-02-18 22:53] Replaced late startup system-property exporter wiring with a dedicated Spring OTLP exporter bean for Langfuse to avoid init-order drops where spans were produced but not exported (`apps/api/src/main/kotlin/com/briefy/api/config/AiObservabilityExporterConfig.kt`).
- 2026-02-18: Mistake: attempted to append AGENT_NOTES with unescaped backticks in zsh, causing command substitution errors; corrected by using single-quoted printf input.
- [2026-02-19 10:24] New pgvector JDBC upsert initially bound `Instant` directly, causing PostgreSQL type inference failure -> switched to `Timestamp.from(now)` in `SourceEmbeddingJdbcRepository` -> when using `NamedParameterJdbcTemplate` with PostgreSQL, bind timestamps explicitly for portable SQL parameter typing.
- [2026-02-19 10:24] Integration test for `source_embeddings` failed FK checks because JPA `save` had not flushed before JDBC insert in same transaction -> changed setup to `saveAndFlush` in `SourceEmbeddingJdbcRepositoryIT` -> when mixing JPA writes and JDBC reads/writes in one test transaction, flush entity writes before raw SQL operations.

## Non-Obvious Code Findings
- [2026-02-19 10:24] `SourceContentFinalizedEvent` is now the canonical downstream trigger for finalized source text: `SourceService` emits it immediately when extraction output is already formatted or cache reuse is final, and `SourceContentFormatterService` emits it on both formatting success and deterministic skip/fallback paths (already formatted, unsupported extractor, model resolution failure, formatter failure) (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormatterService.kt`).
- [2026-02-19 10:24] Embedding space is enforced at schema/config level as a single global model+dimension (`vector(1536)` + `ai.embedding.*`), with non-blocking failure behavior in `SourceEmbeddingService` so ingestion/formatting pipelines remain unaffected if embedding generation fails (`apps/api/src/main/resources/db/migration/V20260219100000__source_embeddings_pgvector.sql`, `apps/api/src/main/kotlin/com/briefy/api/application/enrichment/SourceEmbeddingService.kt`).

- [2026-02-19 10:54] Cleanup pass tightened DEC-056 determinism by validating fixed embedding provider/model/dimension at startup in `EmbeddingProperties` and removed provider/model/dimension env toggles from docs/config; runtime now fails fast on accidental overrides instead of silently degrading embedding generation (`apps/api/src/main/kotlin/com/briefy/api/config/EmbeddingProperties.kt`, `apps/api/src/main/resources/application.yml`, `.env.example`).
- [2026-02-19 10:54] Finalization semantics refined: formatter now emits `SourceContentFinalizedEvent` for deterministic terminal paths (already-formatted/unsupported/skipped/success) but not for transient formatter failures (LLM/settings errors), preventing low-quality raw-content indexing after failed formatting attempts (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceContentFormatterService.kt`).
- [2026-02-19 14:28] Phase 3 briefing slice implemented with persisted `briefing_references` (DEC-013 alignment) and render-ready `citations_json`/optional `conflict_highlights_json` on `briefings`; generation now stores references first and derives citations from both Sources + References (`apps/api/src/main/kotlin/com/briefy/api/application/briefing/BriefingGenerationService.kt`, `apps/api/src/main/resources/db/migration/V20260219130000__briefing_phase3_vertical_slice.sql`).
- [2026-02-19 14:28] Planner now supports deterministic fallback when no `agent_personas` rows are available, so API flow remains functional before persona seeding/customization is complete (`apps/api/src/main/kotlin/com/briefy/api/application/briefing/BriefingPlannerService.kt`).
- [2026-02-19 14:28] Briefing async execution uses DB-backed jobs + scheduled worker with explicit approve gate and manual retry-only contract; no auto-retry loops in worker (`apps/api/src/main/kotlin/com/briefy/api/application/briefing/BriefingGenerationJobService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/briefing/BriefingGenerationWorker.kt`).
- [2026-02-19 14:28] Mistake: modeled large briefing JSON fields with `@Lob`, which caused PostgreSQL schema validation mismatch (`expected oid` vs migrated `TEXT`) in Testcontainers ITs -> fixed by mapping these fields as `@Column(columnDefinition = "TEXT")` so both H2 and PostgreSQL validation pass (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/briefing/Briefing.kt`).
- [2026-02-19 14:28] Mistake: added new briefing exceptions but initially missed handler methods in `GlobalExceptionHandler`, causing 500 responses for invalid briefing state -> fixed by adding explicit 400/403/404 handlers for briefing exceptions (`apps/api/src/main/kotlin/com/briefy/api/api/GlobalExceptionHandler.kt`).
- [2026-02-19 14:28] Assumption locked during implementation: Phase 3 keeps briefing API under `/api/briefings` and defers reference-promotion endpoint to Phase 4 chat/backend work, while still persisting promotion-ready reference IDs now.
- [2026-02-20 19:35] Source list now exposes `pendingSuggestedTopicsCount` directly on `SourceResponse`, computed in one grouped `topic_links` query for active sources to avoid per-card suggestion fetches in the library UI (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/topiclink/TopicLinkRepository.kt`, `apps/web/src/routes/sources/index.tsx`).
- [2026-02-21 17:45] Phase 5 chat frontend V1 implemented in `apps/web` with a global side panel provider (`ChatPanelProvider`), registry-driven dynamic message renderer, and polling-only progress updates (`useBriefingPolling`) mapped from briefing status/plan data. Message mapping keeps `step_progress` mutable via deterministic message IDs (`step_progress:<briefingId>`) so payload updates replace in-place instead of appending noise (`apps/web/src/features/chat/*`).
- [2026-02-21 17:45] Source detail now includes a `Generate Briefing` entry action that opens chat with source context and bootstraps the intent selector flow; briefing result navigation now targets a placeholder briefing detail route (`/briefings/$briefingId`) that renders status, markdown, and citations (`apps/web/src/routes/sources/$sourceId.tsx`, `apps/web/src/routes/briefings/$briefingId.tsx`).
- [2026-02-21 17:45] Mistake: initial `pnpm build` failed due TanStack route types not yet regenerated for newly added route; correction was to run Vite generation/build once, then rerun `pnpm build` successfully. Prevention: after adding file-routes, regenerate route tree before TypeScript build checks in this repo (`apps/web/src/routeTree.gen.ts`).
- [2026-02-21 17:45] User preference reinforced: lock implementation decisions against Obsidian decision logs before coding and keep V1 deterministic/minimal (single active thread, polling transport, guidance CTAs for out-of-scope intents) rather than speculative multi-thread or SSE complexity.
- [2026-02-22 09:59] Chat entry UX preference update: chat trigger should be an icon-only floating circular button (`Sparkles`) at bottom-right on logged-in non-settings routes, plus global `Cmd+J` toggle; source routes should provide default source context only when no active thread exists.
- [2026-02-22 10:45] User preference: keep pace slower in domain discovery, persist domain decisions in Obsidian as they are made, and avoid moving into implementation framing before domain boundaries/contracts are explicitly locked.
- [2026-02-22 17:26] PR #30 chat/source UX constraints: intent selection in chat should be single-shot per active thread (no second briefing creation from the same selector), default floating-chat source context should only be set for `ACTIVE` sources, and topic suggestion state must be cleared/refreshed after apply to avoid stale “discard all” UI (`apps/web/src/features/chat/state/useChatPanelController.ts`, `apps/web/src/routes/sources/$sourceId.tsx`, `apps/web/src/features/sources/useTopicSuggestions.ts`).
- [2026-02-22 17:32] Mistake: used shell backticks in `gh pr create --body`, causing command substitution and a malformed PR description -> fixed with `gh pr edit` using single-quoted body text -> when sending markdown via shell flags, avoid unescaped backticks or pass content through a file.
- [2026-02-22 18:08] Source annotation V1 implemented as source-scoped API (`/api/sources/{sourceId}/annotations`) with active-only listing and server-side overlap guard using anchor start/end offsets. Source archive/restore now cascades annotation archive/restore via `SourceService` to keep lifecycle consistent.
- [2026-02-22 18:32] Annotation popover UX updated per user preference: existing annotations now open on highlight hover (desktop) with hover-safe delayed close, edit/delete actions moved to a three-dots dropdown menu, explicit close button removed, and view state shows relative creation time (`x minutes ago`/`x hours ago`/`Yesterday`/localized date-time). Mobile keeps tap-to-open fallback (`apps/web/src/features/sources/components/SourceAnnotationsContent.tsx`).
- [2026-02-22 18:41] Annotation popover preference refinement: keep annotation body as the primary visual focus (metadata/actions secondary), avoid top-row action-heavy header, and use a softer translucent + blur card treatment for in-context source annotations (`apps/web/src/features/sources/components/SourceAnnotationsContent.tsx`).
- [2026-02-25 09:21] Briefing planning upgraded to AI-first with deterministic fallback: new `AiBriefingPlanGenerator` generates 2-5 plan steps from full source content and persona catalog, while `BriefingPlannerService` falls back to deterministic generation on disabled AI or planner failure (`apps/api/src/main/kotlin/com/briefy/api/application/briefing/AiBriefingPlanGenerator.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/briefing/BriefingPlannerService.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/briefing/DeterministicBriefingPlanGenerator.kt`).
- [2026-02-25 09:35] Briefing planning defaults switched to Google GenAI (`google_genai` + `gemini-2.5-flash`) via `briefing.planning.*` config and generator fallback values, with explicit `.env.example` overrides for environment-level control (`apps/api/src/main/resources/application.yml`, `apps/api/src/main/kotlin/com/briefy/api/application/briefing/AiBriefingPlanGenerator.kt`, `.env.example`).

## User Preferences (Likes / Dislikes)
- [2026-02-25 09:21] User clarified briefing slice is not "fully implemented" while synthesis/investigation remains deterministic -> describe status as workflow/orchestration complete but AI execution pending, and prioritize planning-generation improvements before execution changes.
- [2026-02-23 09:35] Source formatting now has explicit metadata state (`pending|succeeded|failed|not_required`) plus failure reason, exposed via `SourceResponse.metadata` and used by source detail UI to stop infinite formatting spinners and render inline retry/raw actions (`apps/api/src/main/kotlin/com/briefy/api/domain/knowledgegraph/source/Metadata.kt`, `apps/api/src/main/kotlin/com/briefy/api/application/source/SourceDto.kt`, `apps/web/src/features/sources/components/SourceContent.tsx`).
- [2026-02-23 09:35] Added formatting-only retry flow (`POST /api/sources/{id}/formatting/retry`) that is valid only for `ACTIVE` sources with failed formatting state and republishes `SourceContentFormattingRequestedEvent` without re-extraction (`apps/api/src/main/kotlin/com/briefy/api/application/source/SourceService.kt`, `apps/api/src/main/kotlin/com/briefy/api/api/SourceController.kt`, `apps/web/src/lib/api/sources.ts`).
- [2026-02-23 09:35] Mistake corrected during implementation: making `metadata_formatting_state` `NOT NULL` broke source creation because `Source` is first persisted in `SUBMITTED` state with `metadata = null`; fixed by making formatting-state columns nullable at schema level while still setting explicit state whenever metadata exists (`apps/api/src/main/resources/db/migration/V20260223101500__source_formatting_state_and_failure_reason.sql`).
- [2026-02-23 09:35] User preference reinforced: source formatting loading card should explicitly surface failure and offer immediate in-card retry instead of leaving users on indefinite loading.
- [2026-02-24 11:08] PR follow-up fix from review: formatting-state migration backfill now updates only rows with extracted content (`content_text IS NOT NULL`) to avoid marking not-yet-extracted sources as perpetual formatting pending; frontend formatting poll now requires `source.status == active` in addition to pending formatting state (`apps/api/src/main/resources/db/migration/V20260223101500__source_formatting_state_and_failure_reason.sql`, `apps/web/src/features/sources/useSourceData.ts`).
